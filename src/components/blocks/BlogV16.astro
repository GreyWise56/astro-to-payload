---
// src/components/blocks/BlogV16.astro - Dynamic blog post loading

export interface Props {
  heading: string;
  subheading: string;
  button: {
    text: string;
    url: string;
  };
  blogSettings: {
    displayType: 'latest' | 'category' | 'manual';
    numberOfPosts?: number;
    category?: {
      id: string;
      slug: string;
      title: string;
    };
    manualPosts?: Array<{
      id: string;
      title: string;
      slug: string;
      excerpt?: string;
      featuredImage?: {
        url: string;
        alt?: string;
      };
      categories?: Array<{
        title: string;
      }>;
    }>;
    excludePosts?: Array<{
      id: string;
    }>;
  };
}

const { heading, subheading, button, blogSettings } = Astro.props;

// Helper function for image URLs
const getImageUrl = (imageObj: { url: string; alt?: string }) => {
  return imageObj?.url?.startsWith('http') 
    ? imageObj.url 
    : `http://localhost:3000${imageObj?.url || ''}`;
};

// Fetch blog posts based on settings
let displayPosts: Array<{
  title: string;
  category: string;
  url: string;
  image: {
    url: string;
    alt?: string;
  };
}> = [];

try {
  let fetchUrl = 'http://localhost:3000/api/blog?depth=2';
  
  if (blogSettings.displayType === 'manual' && blogSettings.manualPosts) {
    // Use manually selected posts
    displayPosts = blogSettings.manualPosts.map(post => ({
      title: post.title,
      category: post.categories?.[0]?.title || 'Blog',
      url: `/blog/${post.slug}`,
      image: {
        url: getImageUrl(post.featuredImage || { url: '/placeholder-blog.jpg' }),
        alt: post.featuredImage?.alt || post.title,
      },
    }));
  } else {
    // Build query parameters for latest or category posts
    const params = new URLSearchParams();
    
    if (blogSettings.numberOfPosts) {
      params.append('limit', blogSettings.numberOfPosts.toString());
    }
    
    // Add category filter
    if (blogSettings.displayType === 'category' && blogSettings.category) {
      params.append('where[categories][in]', blogSettings.category.id);
    }
    
    // Add exclusions
    if (blogSettings.excludePosts && blogSettings.excludePosts.length > 0) {
      const excludeIds = blogSettings.excludePosts.map(p => p.id).join(',');
      params.append('where[id][not_in]', excludeIds);
    }
    
    // Sort by latest
    params.append('sort', '-createdAt');
    
    const response = await fetch(`${fetchUrl}&${params.toString()}`);
    const data = await response.json();
    
    if (data.docs && Array.isArray(data.docs)) {
      displayPosts = data.docs.map((post: any) => ({
        title: post.title,
        category: post.categories?.[0]?.title || 'Blog',
        url: `/blog/${post.slug}`,
        image: {
          url: getImageUrl(post.featuredImage || { url: '/placeholder-blog.jpg' }),
          alt: post.featuredImage?.alt || post.title,
        },
      }));
    }
  }
} catch (error) {
  console.error('Error fetching blog posts:', error);
  // displayPosts will remain empty array, showing the editor helper
}
---

<section
  class="mt-14 md:mt-16 lg:mt-[88px] xl:mt-[100px] pt-14 md:pt-16 lg:pt-[88px] xl:pt-[100px] mb-14 md:mb-[272px] lg:mb-[260px] xl:mb-[250px] bg-[#DDF3EC] relative w-full"
>
  <div class="container">
    <!-- Section Header -->
    <div
      class="flex flex-col md:flex-row gap-x-10 gap-y-4 justify-center lg:justify-between items-start mb-16 lg:mb-24"
    >
      <!-- Title Area -->
      <div class="flex-1 md:self-start">
        <h2 class="text-appear dark:text-secondary" set:html={heading}></h2>
      </div>

      <!-- Description -->
      <div class="w-full md:max-w-[370px] lg:max-w-[470px] md:self-end">
        <p
          class="text-appear dark:text-colorText max-w-lg md:text-right md:place-self-end"
        >
          {subheading}
        </p>
        <ul class="justify-self-end max-md:w-full mt-5 md:mt-10 reveal-me">
          <li
            class="block md:inline-block w-full mx-auto md:w-auto text-center"
          >
            <a
              href={button.url}
              class="rv-button rv-button-white !bg-[#DDF3EC] block md:inline-block"
            >
              <div
                class="rv-button-top dark:!border-secondary/30 !bg-[#DDF3EC]"
              >
                <span class="!text-secondary">{button.text}</span>
              </div>
              <div class="rv-button-bottom">
                <span>{button.text}</span>
              </div>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Cards Grid -->
    {displayPosts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative">
        {displayPosts.map((post) => (
          <div class="relative group">
            <div>
              <figure class="w-full reveal-me overflow-hidden">
                <img
                  src={post.image.url}
                  alt={post.image.alt || post.title}
                  class="w-full h-auto object-cover transition-all duration-500 group-hover:scale-125 group-hover:rotate-3"
                  loading="lazy"
                  width="400"
                  height="300"
                />
              </figure>

              <div
                class="absolute top-[22%] sm:top-[38%] md:top-1/2 lg:top-3/4 inset-x-[5px] mx-auto bg-backgroundBody dark:bg-dark px-6 pt-6 pb-8 max-w-[calc(100%-10px)] reveal-me"
              >
                <div class="rv-badge mb-3">
                  <span class="rv-badge-text">{post.category}</span>
                </div>

                <div class="blog-title mb-7">
                  <a href={post.url}>
                    <h3 class="text-[34px] lg:leading-[1.05] font-normal">
                      {post.title}
                    </h3>
                  </a>
                </div>

                <div class="w-[90%] mx-auto md:w-auto md:mx-0">
                  <a
                    href={post.url}
                    class="rv-button rv-button-white rv-button-sm-v2 block md:inline-block text-center"
                  >
                    <div class="rv-button-top">
                      <span>Read More</span>
                    </div>
                    <div class="rv-button-bottom">
                      <span>Read More</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <!-- Editor Helper -->
      <div class="text-center py-16">
        <div class="bg-blue-100 border border-blue-300 text-blue-700 px-6 py-4 rounded-lg inline-block">
          <p class="font-semibold">üìù No Blog Posts Found</p>
          <p class="text-sm mt-2">
            {blogSettings.displayType === 'manual' 
              ? 'Please select some blog posts in the block settings.'
              : 'Create some blog posts in the admin or adjust your filter settings.'
            }
          </p>
          <a href="http://localhost:3000/admin/collections/blog" class="text-xs underline mt-1 block">
            ‚Üí Manage Blog Posts
          </a>
        </div>
      </div>
    )}
  </div>
</section>